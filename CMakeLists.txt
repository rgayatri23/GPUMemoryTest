cmake_minimum_required (VERSION 3.12 FATAL_ERROR)
project (GPUMemoryTests LANGUAGES CXX CUDA VERSION 0.0.1)
find_package(CUDA 10.1 REQUIRED)

cuda_add_executable(cmake_axpy.ex axpy.cu)
target_include_directories(cmake_axpy.ex PUBLIC /global/common/cori/software/cuda/10.1/samples/common/inc)

option(PINNED_MEMORY "PINNED MEMORY" OFF)
option(MANAGED_MEMORY "MANAGED MEMORY" OFF)
option(ZERO_COPY "ZERO COPY" OFF)
option(HOST_PAGEABLE_AND_DEVICE_MEMORY "HOST_PAGEABLE_AND_DEVICE_MEMORY " OFF)
option(CHECK_CORRECTNESS "CHECK CORRECTNESS " ON)
option(TIMEMORY_PROFILE "Enable timemory" OFF)
set(CMAKE_VERBOSE_MAKEFILE ON)

if(PINNED_MEMORY)
    add_compile_definitions(USE_PINNED_MEMORY)
elseif(MANAGED_MEMORY)
    add_compile_definitions(USE_MANAGED_MEMORY)
elseif(ZERO_COPY)
    add_compile_definitions(USE_ZERO_COPY)
else()
    add_compile_definitions(USE_HOST_PAGEABLE_AND_DEVICE_MEMORY)
endif()
if(CHECK_CORRECTNESS)
    add_compile_definitions(VERIFY_GPU_CORRECTNESS)
endif()

# if TIMEMORY option is enabled
if(TIMEMORY_PROFILE)
    add_compile_definitions(USE_TIMEMORY)
    target_include_directories(cmake_axpy.ex PUBLIC /project/projectdirs/m1759/timemory/corigpu/include)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMEMORY_USE_CUDA")
endif()
